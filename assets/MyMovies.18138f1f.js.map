{"version":3,"file":"MyMovies.18138f1f.js","sources":["../../src/views/MyMovies.vue"],"sourcesContent":["<script setup>\r\nimport {\r\n  ref,\r\n  nextTick,\r\n  onUpdated,\r\n  onUnmounted,\r\n  getCurrentInstance,\r\n  watch,\r\n} from \"vue\";\r\nimport { useUserStore } from \"@/stores/user.js\";\r\nimport { storeToRefs } from \"pinia\";\r\nimport { apiGetMovieDetail, apiGetNexflixDetail } from \"@/apis/movie.js\";\r\nimport noImg from \"@/assets/image/noImg.jpg\";\r\nimport movieImg from \"@/assets/image/LoginedMovieSlideImgBox.png\";\r\nimport renderComponent from \"@/renderComponent\";\r\nimport MovieModal from \"@/components/Global/Modal/MovieModal.vue\";\r\n\r\nconst store = useUserStore();\r\nconst { userData, myMovies } = storeToRefs(store);\r\n\r\nlet hoverTimer = null;\r\nconst movieList = ref([]);\r\nconst moviesEl = ref(null);\r\nconst isINITed = ref(false);\r\n\r\n// watch 負責處理直接在此頁 render 而非從其他頁過來時使用\r\nwatch(userData, (v) => {\r\n  if (v && !isINITed.value) {\r\n    console.log(\"v\", v);\r\n    INITMyMovies(v.movies);\r\n  }\r\n});\r\n\r\nwatch(myMovies, (v) => {\r\n  if (v && isINITed.value) {\r\n    INITMyMovies(v);\r\n  }\r\n});\r\n\r\nif (userData.value.movies) {\r\n  INITMyMovies(userData.value.movies);\r\n} else {\r\n  setTimeout(() => {\r\n    isINITed.value = true;\r\n  }, 1500);\r\n}\r\n\r\nfunction INITMyMovies(movies = \"\") {\r\n  if (!movies) return (isINITed.value = true);\r\n\r\n  movies = JSON.parse(movies);\r\n  if (!movies.length) {\r\n    movieList.value = [];\r\n    isINITed.value = true;\r\n    return;\r\n  }\r\n\r\n  console.log(\"movies\", movies);\r\n  let promiseArr = [];\r\n  movies.forEach((id) => {\r\n    let p;\r\n    let isNetflix = id.toString().includes(\"n\");\r\n    if (isNetflix) {\r\n      id = id.replace(\"n\", \"\");\r\n      p = apiGetNexflixDetail(id);\r\n    } else {\r\n      p = apiGetMovieDetail(id);\r\n    }\r\n    promiseArr.push(p);\r\n  });\r\n\r\n  Promise.all(promiseArr)\r\n    .then(async (values) => {\r\n      let result = [];\r\n      values.forEach((v) => {\r\n        result.push(v.data);\r\n      });\r\n\r\n      movieList.value = result.map((d) => {\r\n        let id = d.id;\r\n        let isNetflix = movies.find((_id) => _id.toString().includes(id))\r\n          ? true\r\n          : false;\r\n\r\n        return {\r\n          id: d.id,\r\n          //   url: d.poster_path,\r\n          url: d.backdrop_path, // 改長寬的圖\r\n          title: d.title ? d.title : d.name,\r\n          score: d.vote_average,\r\n          movie: d,\r\n          isNetflix,\r\n        };\r\n      });\r\n\r\n      isINITed.value = true;\r\n      await nextTick();\r\n      setLazyLoad();\r\n    })\r\n    .catch(() => {\r\n      isINITed.value = true;\r\n    });\r\n}\r\n\r\nfunction setLazyLoad() {\r\n  const imgs = moviesEl.value.querySelectorAll(\"a.movie-item\");\r\n  const option = {\r\n    root: document.querySelector(\".myMovies-wrapper\"),\r\n    rootMargin: \"100px\",\r\n  };\r\n  const observer = new IntersectionObserver((nodes) => {\r\n    nodes.forEach((v) => {\r\n      // 進入可視區域才加載\r\n      if (v.isIntersecting) {\r\n        let bgImg;\r\n        if (v.target.dataset.src) {\r\n          bgImg = `url(https://image.tmdb.org/t/p/w300${v.target.dataset.src})`;\r\n        } else {\r\n          bgImg = `url(${noImg})`;\r\n        }\r\n        v.target.style.backgroundImage = bgImg;\r\n\r\n        // 避免 skeleton 動畫還沒運作而直接關閉，導致畫面閃爍\r\n        setTimeout(() => {\r\n          v.target.classList.add(\"active\");\r\n        }, 800);\r\n        observer.unobserve(v.target); // 停止監聽已加載圖片\r\n      }\r\n    });\r\n  }, option);\r\n  imgs.forEach((v) => observer.observe(v));\r\n}\r\n\r\nlet destroyComp = null;\r\nonUnmounted(() => destroyComp?.());\r\n\r\nonUpdated(() => {\r\n  movieSlidesBindHoverEvent();\r\n});\r\n\r\nfunction movieSlidesBindHoverEvent() {\r\n  let wrapper = moviesEl.value;\r\n  // 為了抓取到 swiper loop 自己生成的元素，透過 nextTick 後再抓取 dom 添加 eventlistener\r\n  nextTick(() => {\r\n    let movies = wrapper.querySelectorAll(\".movies-list\");\r\n    movies.forEach((item) => {\r\n      item.addEventListener(\"mouseover\", mouseoverHandler);\r\n      item.addEventListener(\"mouseleave\", mouseLeaveHandler);\r\n    });\r\n  });\r\n\r\n  document.body.addEventListener(\"mouseover\", checkIsHovered);\r\n}\r\n\r\nfunction mouseoverHandler(e) {\r\n  hoverTimer = setTimeout(() => {\r\n    const parent = e.target.parentElement;\r\n    if (parent?.dataset?.movieIndex) {\r\n      let index = parent.dataset.movieIndex;\r\n      let movie = movieList.value[index];\r\n      const { x, y, width, height } = getCoords(e.target, \"center\");\r\n\r\n      const bodyWidth = document.body.getBoundingClientRect()?.width;\r\n      createPreviewMovieModal({\r\n        x,\r\n        y,\r\n        width,\r\n        height,\r\n        movie,\r\n        // 處理 slide 前後 sacle 時往左放大與往右放大\r\n        isFirstItem: x - width < 0 ? true : false,\r\n        isLastItem: x + width > bodyWidth ? true : false,\r\n      });\r\n    }\r\n  }, 500);\r\n}\r\nfunction mouseLeaveHandler() {\r\n  clearTimeout(hoverTimer);\r\n}\r\n\r\nfunction checkIsHovered(e) {\r\n  let el = e.target;\r\n  let target = document.querySelector(\"#triggerModal\");\r\n  if (!target) return;\r\n\r\n  if (el !== target && !target.contains(e.target)) {\r\n    let previewWrapper = target.querySelector(\".previewMovie-wrapper\");\r\n    if (previewWrapper) {\r\n      previewWrapper.classList.remove(\"active\");\r\n      setTimeout(() => {\r\n        destroyComp?.();\r\n      }, 295);\r\n    }\r\n  }\r\n}\r\nconst { appContext } = getCurrentInstance();\r\nconst createPreviewMovieModal = async (data) => {\r\n  destroyComp?.();\r\n  destroyComp = renderComponent({\r\n    el: \"#triggerModal\",\r\n    component: (await import(\"@/components/Slide/PreviewSlideMovie.vue\"))\r\n      .default,\r\n    props: {\r\n      key: data.movie.id,\r\n      movie: data.movie,\r\n      left: data.x,\r\n      top: data.y,\r\n      width: data.width,\r\n      height: data.height,\r\n      imgurl: data.movie.url,\r\n      imgbox: movieImg,\r\n      isFirstItem: data.isFirstItem,\r\n      isLastItem: data.isLastItem,\r\n    },\r\n    appContext,\r\n  });\r\n};\r\n\r\nfunction getCoords(element, position) {\r\n  const { top, left, width, height } = element.getBoundingClientRect();\r\n  let point;\r\n  switch (position) {\r\n    case \"top left\":\r\n      point = {\r\n        x: left + window.pageXOffset,\r\n        y: top + window.pageYOffset,\r\n      };\r\n      break;\r\n    case \"top center\":\r\n      point = {\r\n        x: left + width / 2 + window.pageXOffset,\r\n        y: top + window.pageYOffset,\r\n      };\r\n      break;\r\n    case \"top right\":\r\n      point = {\r\n        x: left + width + window.pageXOffset,\r\n        y: top + window.pageYOffset,\r\n      };\r\n      break;\r\n    case \"center left\":\r\n      point = {\r\n        x: left + window.pageXOffset,\r\n        y: top + height / 2 + window.pageYOffset,\r\n      };\r\n      break;\r\n    case \"center\":\r\n      point = {\r\n        x: left + width / 2 + window.pageXOffset,\r\n        y: top + height / 2 + window.pageYOffset,\r\n      };\r\n      break;\r\n    case \"center right\":\r\n      point = {\r\n        x: left + width + window.pageXOffset,\r\n        y: top + height / 2 + window.pageYOffset,\r\n      };\r\n      break;\r\n    case \"bottom left\":\r\n      point = {\r\n        x: left + window.pageXOffset,\r\n        y: top + height + window.pageYOffset,\r\n      };\r\n      break;\r\n    case \"bottom center\":\r\n      point = {\r\n        x: left + width / 2 + window.pageXOffset,\r\n        y: top + height + window.pageYOffset,\r\n      };\r\n      break;\r\n    case \"bottom right\":\r\n      point = {\r\n        x: left + width + window.pageXOffset,\r\n        y: top + height + window.pageYOffset,\r\n      };\r\n      break;\r\n  }\r\n\r\n  point.width = width;\r\n  point.height = height;\r\n  return point;\r\n}\r\n</script>\r\n\r\n<template>\r\n  <div class=\"myMovies-wrapper\">\r\n    <div class=\"myMovies-wrapper-title\">\r\n      <h3>我的片單</h3>\r\n    </div>\r\n    <div v-if=\"isINITed\">\r\n      <div class=\"movies-content\" ref=\"moviesEl\" v-if=\"movieList.length\">\r\n        <!-- Slides -->\r\n        <div\r\n          class=\"movies-list\"\r\n          :key=\"index\"\r\n          v-for=\"(movie, index) in movieList\"\r\n          :data-movie-index=\"index\"\r\n        >\r\n          <a class=\"movie-item\" :data-src=\"movie.url\">\r\n            <img :src=\"movieImg\" alt=\"\" />\r\n          </a>\r\n        </div>\r\n      </div>\r\n      <div v-else style=\"width: 100%\">\r\n        <h3 style=\"font-size: 24px\">尚未添加電影到我的片單</h3>\r\n      </div>\r\n    </div>\r\n    <div v-else>\r\n      <div class=\"movies-content INITing\">\r\n        <div class=\"movies-list\">\r\n          <a class=\"movie-item\">\r\n            <img :src=\"movieImg\" alt=\"\" />\r\n          </a>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- 負責呈現 hover preview -->\r\n    <div id=\"triggerModal\" ref=\"triggerModal\"></div>\r\n\r\n    <MovieModal ref=\"modal\" />\r\n  </div>\r\n</template>\r\n\r\n<style lang=\"scss\" scoped>\r\n.myMovies-wrapper {\r\n  min-height: 100vh;\r\n  width: 100%;\r\n  padding: 0 3%;\r\n  @media screen and (max-width: 768px) {\r\n    padding: 0 4%;\r\n  }\r\n}\r\n.myMovies-wrapper-title {\r\n  padding-top: 70px;\r\n  padding-bottom: 70px;\r\n  h3 {\r\n    font-size: 2rem;\r\n  }\r\n  @media screen and (max-width: 800px) {\r\n    padding-bottom: 25px;\r\n    h3 {\r\n      font-size: 1.8rem;\r\n    }\r\n  }\r\n}\r\n.movies-content {\r\n  display: grid;\r\n  grid-template-columns: 16.66665% 16.66665% 16.66665% 16.66665% 16.66665% 16.66665%;\r\n  margin: -5px;\r\n\r\n  @media screen and (max-width: 1400px) {\r\n    grid-template-columns: 20% 20% 20% 20% 20%;\r\n  }\r\n\r\n  @media screen and (max-width: 1100px) {\r\n    grid-template-columns: 25% 25% 25% 25%;\r\n  }\r\n  @media screen and (max-width: 800px) {\r\n    grid-template-columns: 33.33333% 33.33333% 33.33333%;\r\n  }\r\n  @media screen and (max-width: 500px) {\r\n    grid-template-columns: 50% 50%;\r\n  }\r\n\r\n  .movies-list {\r\n    margin: 5px;\r\n    position: relative;\r\n    border-radius: 5px;\r\n    overflow: hidden;\r\n    transition: ease 0.3s;\r\n    margin-bottom: 45px;\r\n\r\n    @media screen and (max-width: 500px) {\r\n      margin-bottom: 35px;\r\n    }\r\n\r\n    .movie-item {\r\n      display: block;\r\n      background-position: center center;\r\n      background-repeat: no-repeat;\r\n      background-size: cover;\r\n      position: relative;\r\n\r\n      @media screen and (max-width: 480px) {\r\n        overflow: hidden;\r\n        border-radius: 5px;\r\n      }\r\n\r\n      // 負責呈現 skeleton\r\n      &::before {\r\n        content: \"\";\r\n        position: absolute;\r\n        left: 0;\r\n        top: 0;\r\n        display: block;\r\n        width: 100%;\r\n        height: 100%;\r\n\r\n        background: var(--skeleton-bg);\r\n      }\r\n\r\n      // 負責呈現 skeleton\r\n      &::after {\r\n        content: \"\";\r\n        position: absolute;\r\n        left: 0;\r\n        top: 0;\r\n        display: block;\r\n        width: 100%;\r\n        height: 100%;\r\n\r\n        background: linear-gradient(\r\n          90deg,\r\n          rgba(190, 190, 190, 0.2) 25%,\r\n          rgba(129, 129, 129, 0.24) 37%,\r\n          rgba(190, 190, 190, 0.2) 63%\r\n        );\r\n        background-size: 400% 100%;\r\n        animation: ant-skeleton-loading 1.4s ease infinite;\r\n      }\r\n    }\r\n\r\n    .movie-item.active {\r\n      &::before {\r\n        display: none;\r\n      }\r\n      &::after {\r\n        display: none;\r\n      }\r\n    }\r\n\r\n    .info {\r\n      display: none;\r\n    }\r\n    img {\r\n      position: relative;\r\n      z-index: -1; // 呈現 movie-item 背景圖用\r\n      width: 100%;\r\n      height: auto;\r\n      visibility: hidden; // 避免顯示圖片文字\r\n    }\r\n  }\r\n  .title {\r\n    color: var(--color-text);\r\n    display: block;\r\n    text-align: center;\r\n    margin-top: 2px;\r\n    font-size: 16px;\r\n    position: absolute;\r\n    left: 50%;\r\n    transform: translateX(-50%);\r\n    width: 100%;\r\n\r\n    @media screen and (max-width: 480px) {\r\n      font-size: 14px;\r\n    }\r\n  }\r\n}\r\n\r\n@media screen and (max-width: 480px) {\r\n  .movies-content {\r\n    .movies-list {\r\n      border-radius: 5px;\r\n    }\r\n  }\r\n}\r\n</style>\r\n"],"names":[],"mappings":"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"}